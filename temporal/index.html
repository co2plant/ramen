<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚˜ë¥¼ ìœ„í•œ ë¼ë©˜ ë§›ì§‘ ì°¾ê¸°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Do+Hyeon&family=Gowun+Dodum&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Gowun Dodum', sans-serif;
            background: #232526;
            background: -webkit-linear-gradient(to right, #414345, #232526);
            background: linear-gradient(to right, #414345, #232526);
            color: #E5E7EB;
        }
        .font-title { font-family: 'Do Hyeon', sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .modal-bg { background-color: rgba(0, 0, 0, 0.7); }
        .modal-content { max-height: 90vh; }
        .tag { transition: all 0.2s ease-in-out; border-color: #4B5563; }
        .tag:hover { background-color: #4B5563; }
        .tag.active { background-color: #F97316; color: white; font-weight: 700; border-color: #F97316; }
        .sort-btn.active { background-color: #EA580C; color: white; border-color: #EA580C; }
        input[type="range"] { -webkit-appearance: none; appearance: none; width: 100%; height: 6px; background: #4b5563; border-radius: 5px; outline: none; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; background: #F97316; cursor: pointer; border-radius: 50%; border: 2px solid #1F2937; }
        input[type="range"]::-moz-range-thumb { width: 20px; height: 20px; background: #F97316; cursor: pointer; border-radius: 50%; border: 2px solid #1F2937; }
        .star-rating .star { color: #6b7280; transition: color 0.2s; cursor: pointer; }
        .star-rating .star:hover, .star-rating .star.selected { color: #f59e0b; }
        .new-review { border: 2px solid #f59e0b; animation: fadeOutBorder 3s forwards; }
        @keyframes fadeOutBorder { from { border-color: #f59e0b; } to { border-color: transparent; } }
        .spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #f97316;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="antialiased">

    <div class="container mx-auto max-w-7xl p-4">
        <header class="text-center my-10 relative">
            <div class="absolute top-0 right-0" id="auth-section">
                <button id="login-btn" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded-lg transition">ë¼ì˜¤íƒ€ ë¡œê·¸ì¸</button>
                <div id="user-info" class="hidden items-center gap-4">
                    <span id="user-display" class="text-orange-400 font-semibold"></span>
                    <button id="logout-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition">ë¡œê·¸ì•„ì›ƒ</button>
                </div>
            </div>
            <h1 class="font-title text-6xl font-bold text-orange-400 drop-shadow-lg" style="letter-spacing: 2px;">ğŸœ ë‚˜ë¥¼ ìœ„í•œ ë¼ë©˜ ë§›ì§‘ ì°¾ê¸°</h1>
            <p class="text-gray-400 mt-4 text-lg">ì„œìš¸ì˜ ìˆ¨ê²¨ì§„ ë¼ë©˜ ê³ ìˆ˜ë“¤ì˜ ì„±ì§€ë¥¼ ì°¾ì•„ë³´ì„¸ìš”!</p>
            <div id="location-status" class="mt-6 text-sm text-gray-300 bg-gray-700/50 rounded-full px-4 py-2 inline-block border border-gray-600">
                ğŸ“ ìœ„ì¹˜ ì •ë³´ í™•ì¸ ì¤‘...
            </div>
        </header>

        <div class="flex flex-col lg:flex-row gap-8">
            <!-- Left Sidebar: Filters -->
            <aside class="w-full lg:w-1/4 xl:w-1/5 bg-gray-800/50 backdrop-blur-sm border border-gray-700 p-6 rounded-2xl shadow-lg h-fit">
                <h2 class="font-title text-2xl font-bold mb-6 border-b border-gray-600 pb-3 text-orange-400">ìƒì„¸ ê²€ìƒ‰ ğŸ®</h2>
                <div class="mb-6">
                    <h3 class="font-semibold mb-3 text-gray-300">ë¼ë©˜ ì¢…ë¥˜</h3>
                    <div id="category-filters" class="flex flex-wrap gap-2"></div>
                </div>
                <div class="mb-6">
                    <h3 class="font-semibold mb-2 text-gray-300">ìµœëŒ€ ê°€ê²©</h3>
                    <input type="range" id="price-filter" min="8000" max="20000" step="1000" value="20000" class="w-full cursor-pointer">
                    <div class="text-right mt-2 text-sm font-medium text-orange-400">â‚©<span id="price-value">20,000</span></div>
                </div>
                <div class="mb-6">
                    <h3 class="font-semibold mb-2 text-gray-300">ìµœëŒ€ ê±°ë¦¬</h3>
                    <input type="range" id="distance-filter" min="1" max="20" step="1" value="20" class="w-full cursor-pointer">
                    <div class="text-right mt-2 text-sm font-medium text-orange-400"><span id="distance-value">20</span> km ì´ë‚´</div>
                </div>
                <button id="reset-filters" class="w-full bg-gray-600 hover:bg-gray-500 text-gray-200 font-bold py-2 px-4 rounded-lg transition duration-200">ğŸ”„ ì´ˆê¸°í™”</button>
            </aside>

            <!-- Right Content: Shop List -->
            <main class="w-full lg:w-3/4 xl:w-4/5">
                <div class="flex justify-end gap-2 mb-4">
                    <button data-sort="rating" class="sort-btn bg-gray-700/80 shadow-md hover:bg-gray-600 text-gray-200 font-semibold py-2 px-4 border border-gray-600 rounded-lg transition active">â­ ë³„ì ìˆœ</button>
                    <button data-sort="distance" class="sort-btn bg-gray-700/80 shadow-md hover:bg-gray-600 text-gray-200 font-semibold py-2 px-4 border border-gray-600 rounded-lg transition">ğŸš— ê±°ë¦¬ìˆœ</button>
                </div>
                <div id="shop-list" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6"></div>
                <div id="no-results" class="hidden text-center py-16 bg-gray-800/50 border border-gray-700 rounded-2xl shadow-lg">
                    <p class="text-4xl">ğŸœ</p>
                    <p class="text-xl font-semibold mt-4 text-gray-300">ì¡°ê±´ì— ë§ëŠ” ë¼ë©˜ì§‘ì´ ì—†ì–´ìš”.</p>
                    <p class="text-gray-500 mt-1">í•„í„°ë¥¼ ì¡°ì •í•´ë³´ì„¸ìš”!</p>
                </div>
            </main>
        </div>
    </div>

    <!-- Shop Detail Modal -->
    <div id="modal" class="fixed inset-0 z-50 items-center justify-center hidden">
        <div class="modal-bg fixed inset-0 backdrop-blur-sm"></div>
        <div id="modal-content" class="modal-content bg-gray-800 border border-gray-700 w-11/12 max-w-2xl mx-auto rounded-2xl shadow-2xl relative transform transition-all duration-300 ease-out scale-95 opacity-0 overflow-y-auto no-scrollbar"></div>
    </div>

    <!-- Login Modal -->
    <div id="login-modal" class="fixed inset-0 z-50 items-center justify-center hidden">
        <div class="modal-bg fixed inset-0 backdrop-blur-sm"></div>
        <div class="bg-gray-800 border border-gray-700 w-11/12 max-w-sm mx-auto rounded-2xl shadow-2xl p-8 relative">
            <h2 class="font-title text-3xl text-center text-orange-400 mb-6">ë¼ì˜¤íƒ€ ë¡œê·¸ì¸</h2>
            <form id="login-form">
                <input type="text" id="username-input" placeholder="ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: raota)" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 mb-4 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-orange-500">
                <button type="submit" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-4 rounded-lg transition">ë¡œê·¸ì¸</button>
            </form>
            <p id="login-error" class="text-red-400 text-center mt-4 text-sm hidden">ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì•„ì´ë””ì…ë‹ˆë‹¤.</p>
            <button id="close-login-modal" class="absolute top-4 right-5 text-gray-400 hover:text-white text-3xl transition-colors">&times;</button>
        </div>
    </div>

<script>
// --- ë°ì´í„°ë² ì´ìŠ¤ ---
const raotaUsers = [
    { id: 'raota', name: 'ë¼ë©˜ì˜¤íƒ€ì¿ ' },
    { id: 'expert', name: 'ë¼ë©˜ì „ë¬¸ê°€' }
];

const ramenShops = [
    { id: 1, name: "ì˜¤ë ˆë…¸ë¼ë©˜", category: "í† ë¦¬íŒŒì´íƒ„", address: "ì„œìš¸ ë§ˆí¬êµ¬ ë…ë§‰ë¡œ19ê¸¸ 13", geo: { lat: 37.5516, lng: 126.9247 }, image: "https://placehold.co/600x400/FFF4E6/F97316?text=Tori+Paitan", avg_rating: 4.8, menu: [{ name: "í† ë¦¬íŒŒì´íƒ„ ë¼ë©˜", price: 11000, rating: 4.9 }, { name: "ì¹´ë¼íŒŒì´íƒ„ ë¼ë©˜", price: 11500, rating: 4.7 }, { name: "ì‡¼ìœ  ë¼ë©˜", price: 10000, rating: 4.6 }], reviews: [{ user: "ë¼ë©˜ì¸í”Œë£¨ì–¸ì„œA", menu: "í† ë¦¬íŒŒì´íƒ„ ë¼ë©˜", rating: 5, comment: "'í† ë¦¬íŒŒì´íƒ„'ì€ ì§„í•˜ê³  ë¶€ë“œëŸ¬ìš´ ë‹­ìœ¡ìˆ˜ì˜ ì •ì„! ê¼­ ë“œì…”ë³´ì„¸ìš”." }, { user: "ìƒìœ„ë¦¬ë·°ì–´B", menu: "ì¹´ë¼íŒŒì´íƒ„ ë¼ë©˜", rating: 4, comment: "ë©´ ì¶”ê°€ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤. êµ­ë¬¼ì´ ì •ë§ ëë‚´ì¤˜ìš”." }] },
    { id: 2, name: "í•˜ì¿ í…", category: "ëˆì½”ì¸ ", address: "ì„œìš¸ ë§ˆí¬êµ¬ ì™€ìš°ì‚°ë¡œ29ê¸¸ 14-6", geo: { lat: 37.5582, lng: 126.9116 }, image: "https://placehold.co/600x400/F3E8FF/8B5CF6?text=Donkotsu", avg_rating: 4.7, menu: [{ name: "ëˆì½”ì¸  ë¼ë©˜", price: 9000, rating: 4.8 }, { name: "ì¹´ë¼êµ¬ì¹˜ ë¼ë©˜", price: 9500, rating: 4.6 }, { name: "ì°¨ìŠˆ ì¶”ê°€", price: 3000, rating: 4.9 }], reviews: [{ user: "ë§›ì˜ì•Œ C", menu: "ëˆì½”ì¸  ë¼ë©˜", rating: 5, comment: "ì§„í•œ ë¼ì§€ë¼ˆ ìœ¡ìˆ˜ë¥¼ ì¢‹ì•„í•œë‹¤ë©´ ë¬´ì¡°ê±´ 'ëˆì½”ì¸  ë¼ë©˜'ì…ë‹ˆë‹¤. ì°¨ìŠˆ ì¶”ê°€ëŠ” êµ­ë£°." }, { user: "í™ëŒ€ì£¼ë¯¼ D", menu: "ì¹´ë¼êµ¬ì¹˜ ë¼ë©˜", rating: 4, comment: "ì›¨ì´íŒ…ì´ ê¸¸ì§€ë§Œ ê·¸ë§Œí•œ ê°€ì¹˜ê°€ ìˆëŠ” ê³³. ë§¤ì½¤í•œ ê±¸ ì›í•˜ë©´ ì¹´ë¼êµ¬ì¹˜ë¡œ!" }] },
    { id: 3, name: "ë©˜í…", category: "ì‡¼ìœ ", address: "ì„œìš¸ ì¤‘êµ¬ í‡´ê³„ë¡œ 90", geo: { lat: 37.5698, lng: 126.9772 }, image: "https://placehold.co/600x400/E0F2FE/0EA5E9?text=Shoyu", avg_rating: 4.9, menu: [{ name: "ì‡¼ìœ  ë¼ë©˜", price: 12000, rating: 4.9 }, { name: "ì‹œì˜¤ ë¼ë©˜", price: 12000, rating: 4.8 }, { name: "íƒ„íƒ„ë©˜", price: 13000, rating: 4.7 }], reviews: [{ user: "ë¼ë©˜í‰ë¡ ê°€ E", menu: "ì‡¼ìœ  ë¼ë©˜", rating: 5, comment: "ê°„ì¥ì˜ í’ë¯¸ê°€ ì‚´ì•„ìˆëŠ” 'ì‡¼ìœ  ë¼ë©˜'ì€ í•œ ê·¸ë¦‡ì˜ ì˜ˆìˆ ì‘í’ˆ ê°™ì•„ìš”." }, { user: "ê´‘í™”ë¬¸ì§ì¥ì¸ F", menu: "ì‹œì˜¤ ë¼ë©˜", rating: 5, comment: "ì ì‹¬ì‹œê°„ì— ëˆ„ë¦´ ìˆ˜ ìˆëŠ” ìµœê³ ì˜ í˜¸ì‚¬. êµ­ë¬¼ì´ ì •ë§ ë§‘ê³  ê¹Šì–´ìš”." }] },
];

// --- ì „ì—­ ë³€ìˆ˜ ë° ìƒíƒœ ---
let userLocation = null;
let loggedInUser = null;
let currentFilters = { category: 'all', maxPrice: 20000, maxDistance: 20 };
let currentSort = 'rating';
let allShopsWithDistance = [];

// --- DOM ìš”ì†Œ ---
const locationStatus = document.getElementById('location-status');
const shopList = document.getElementById('shop-list');
const noResults = document.getElementById('no-results');
const categoryFilters = document.getElementById('category-filters');
const priceFilter = document.getElementById('price-filter');
const priceValue = document.getElementById('price-value');
const distanceFilter = document.getElementById('distance-filter');
const distanceValue = document.getElementById('distance-value');
const resetFiltersBtn = document.getElementById('reset-filters');
const sortBtns = document.querySelectorAll('.sort-btn');
const modal = document.getElementById('modal');
const modalContent = document.getElementById('modal-content');
const modalBg = document.querySelector('#modal .modal-bg');
const loginModal = document.getElementById('login-modal');
const loginModalBg = document.querySelector('#login-modal .modal-bg');
const loginBtn = document.getElementById('login-btn');
const logoutBtn = document.getElementById('logout-btn');
const userInfo = document.getElementById('user-info');
const userDisplay = document.getElementById('user-display');
const loginForm = document.getElementById('login-form');
const usernameInput = document.getElementById('username-input');
const loginError = document.getElementById('login-error');
const closeLoginModalBtn = document.getElementById('close-login-modal');

// --- Gemini API í•¨ìˆ˜ ---
async function callGemini(prompt) {
    const apiKey = ""; // API í‚¤ëŠ” ë¹„ì›Œ ë‘¡ë‹ˆë‹¤.
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
    
    let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
    const payload = { contents: chatHistory };

    try {
        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        if (!response.ok) {
            throw new Error(`API í˜¸ì¶œ ì‹¤íŒ¨: ${response.status}`);
        }
        const result = await response.json();
        if (result.candidates && result.candidates.length > 0 &&
            result.candidates[0].content && result.candidates[0].content.parts &&
            result.candidates[0].content.parts.length > 0) {
            return result.candidates[0].content.parts[0].text;
        } else {
            return "AIê°€ ì‘ë‹µì„ ìƒì„±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
        }
    } catch (error) {
        console.error("Gemini API Error:", error);
        return "AI ê¸°ëŠ¥ ì‚¬ìš© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
    }
}

// --- í•µì‹¬ ë¡œì§ ---
function getDistance(lat1, lon1, lat2, lon2) {
    const R = 6371;
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
}

function renderShops(shops) {
    shopList.innerHTML = '';
    if (shops.length === 0) {
        noResults.classList.remove('hidden');
        shopList.classList.add('hidden');
        return;
    }
    noResults.classList.add('hidden');
    shopList.classList.remove('hidden');

    shops.forEach(shop => {
        const locationInfo = shop.distance !== null ? `<span class="text-orange-400 font-semibold">ğŸš— ${shop.distance.toFixed(1)} km</span>` : `<span class="text-gray-400 text-xs">ğŸ“ ${shop.address}</span>`;
        const card = document.createElement('div');
        card.className = 'bg-gray-800/60 border border-gray-700 rounded-2xl shadow-lg overflow-hidden transform hover:-translate-y-2 transition-transform duration-300 cursor-pointer group';
        card.dataset.shopId = shop.id;
        card.innerHTML = `
            <div class="overflow-hidden"><img src="${shop.image}" alt="${shop.name}" class="w-full h-48 object-cover group-hover:scale-110 transition-transform duration-500" onerror="this.onerror=null;this.src='https://placehold.co/600x400/cccccc/ffffff?text=Image+Error';"></div>
            <div class="p-5 flex flex-col h-full">
                <div class="flex justify-between items-start">
                    <h3 class="font-title text-2xl font-bold mb-1 text-gray-100">${shop.name}</h3>
                    <span class="text-sm font-bold bg-orange-500/20 text-orange-400 px-2.5 py-1 rounded-full border border-orange-500/30">â­ ${shop.avg_rating.toFixed(1)}</span>
                </div>
                <p class="text-gray-400 text-sm mb-3">${shop.category}</p>
                <div class="flex justify-between items-center text-sm text-gray-300">
                    <span>${shop.menu[0].name}</span>
                    <span class="font-semibold text-gray-100">â‚©${shop.menu[0].price.toLocaleString()}</span>
                </div>
                <div class="mt-auto pt-4 border-t border-gray-700 text-right">${locationInfo}</div>
            </div>`;
        card.addEventListener('click', () => openModal(shop.id));
        shopList.appendChild(card);
    });
}

function applyFiltersAndSort() {
    let filtered = allShopsWithDistance.filter(shop => {
        const priceMatch = shop.menu.some(m => m.price <= currentFilters.maxPrice);
        const categoryMatch = currentFilters.category === 'all' || shop.category === currentFilters.category;
        const distanceMatch = userLocation ? (shop.distance !== null ? shop.distance <= currentFilters.maxDistance : true) : true;
        return priceMatch && categoryMatch && distanceMatch;
    });

    filtered.sort((a, b) => {
        if (currentSort === 'rating') return b.avg_rating - a.avg_rating;
        if (currentSort === 'distance' && userLocation) {
            if (a.distance === null) return 1;
            if (b.distance === null) return -1;
            return a.distance - b.distance;
        }
        return 0;
    });
    renderShops(filtered);
}

function openModal(shopId, newReviewId = null) {
    const shop = allShopsWithDistance.find(s => s.id === shopId);
    if (!shop) return;
    
    const reviewListHtml = shop.reviews.map((review, index) => `
        <li class="bg-gray-700/50 p-4 rounded-lg border border-gray-600 ${newReviewId === index ? 'new-review' : ''}">
            <div class="flex justify-between items-center mb-1">
                <p class="font-semibold text-orange-400">${review.user}</p>
                <div class="text-amber-400 text-xs">${'â˜…'.repeat(review.rating)}${'â˜†'.repeat(5 - review.rating)}</div>
            </div>
            <p class="text-gray-400 text-sm font-semibold mb-2">${review.menu}</p>
            <p class="text-gray-300 text-sm">"${review.comment}"</p>
        </li>`).reverse().join('');

    const aiFeaturesHtml = `
        <div class="mt-8 p-4 bg-gray-900/50 rounded-lg border border-gray-700">
            <h3 class="font-title text-xl font-semibold mb-4 text-orange-400">âœ¨ AI ê¸°ëŠ¥</h3>
            <div class="space-y-4">
                <div>
                    <button id="ai-summary-btn" class="w-full flex items-center justify-center gap-2 bg-orange-600/80 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded-lg transition">
                        AI ë¦¬ë·° ìš”ì•½
                    </button>
                    <div id="ai-summary-result" class="hidden mt-3 p-3 bg-gray-700/50 rounded-md text-sm text-gray-300"></div>
                </div>
                <div>
                    <button id="ai-pairing-btn" class="w-full flex items-center justify-center gap-2 bg-sky-600/80 hover:bg-sky-600 text-white font-bold py-2 px-4 rounded-lg transition">
                        AI í˜ì–´ë§ ì¶”ì²œ
                    </button>
                    <div id="ai-pairing-result" class="hidden mt-3 p-3 bg-gray-700/50 rounded-md text-sm text-gray-300"></div>
                </div>
            </div>
        </div>
    `;

    const addReviewForm = `
        <div id="add-review-section" class="mt-8">
            <h3 class="font-title text-2xl font-semibold mb-4 border-b-2 border-gray-700 pb-2 text-gray-200">ğŸ–‹ï¸ ë¦¬ë·° ì‘ì„±</h3>
            <form id="add-review-form" data-shop-id="${shop.id}" class="space-y-4">
                <div>
                    <label for="review-menu-select" class="block text-sm font-medium text-gray-300 mb-1">ë©”ë‰´ ì„ íƒ</label>
                    <select id="review-menu-select" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-orange-500">
                        ${shop.menu.map(m => `<option value="${m.name}">${m.name}</option>`).join('')}
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-1">ë³„ì </label>
                    <div id="star-rating" class="star-rating flex text-2xl" data-rating="0">
                        ${[1, 2, 3, 4, 5].map(v => `<span class="star" data-value="${v}">â˜…</span>`).join('')}
                    </div>
                </div>
                <textarea id="review-text" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-orange-500" rows="3" placeholder="ë¦¬ë·°ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”..." required></textarea>
                <button type="submit" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-4 rounded-lg transition">ì‘ì„± ì™„ë£Œ</button>
            </form>
        </div>`;

    modalContent.innerHTML = `
        <button id="close-modal" class="absolute top-4 right-5 text-gray-400 hover:text-white text-3xl z-10 transition-colors">&times;</button>
        <img src="${shop.image}" alt="${shop.name}" class="w-full h-64 object-cover rounded-t-2xl" onerror="this.onerror=null;this.src='https://placehold.co/600x400/cccccc/ffffff?text=Image+Error';">
        <div class="p-8">
            <div class="flex justify-between items-center mb-2">
                <h2 class="font-title text-4xl font-bold text-orange-400">${shop.name}</h2>
                <span class="text-xl font-bold bg-orange-500/20 text-orange-400 px-3 py-1.5 rounded-full border border-orange-500/30">â­ ${shop.avg_rating.toFixed(1)}</span>
            </div>
            <p class="text-gray-400 text-md mb-4">${shop.category} ë¼ë©˜ ì „ë¬¸ì </p>
            <p class="text-gray-300 text-sm mb-8 flex items-center"><span class="mr-2 text-lg">ğŸ“</span>${shop.address}</p>
            <div class="mb-8">
                <h3 class="font-title text-2xl font-semibold mb-4 border-b-2 border-gray-700 pb-2 text-gray-200">ğŸ“‹ ëŒ€í‘œ ë©”ë‰´</h3>
                <ul class="space-y-3 text-gray-300">
                    ${shop.menu.map(item => `<li class="flex justify-between items-center"><span>${item.name}</span><span class="font-semibold text-gray-100">â­ ${item.rating.toFixed(1)}</span></li>`).join('')}
                </ul>
            </div>
            ${aiFeaturesHtml}
            <div class="mt-8">
                <h3 class="font-title text-2xl font-semibold mb-4 border-b-2 border-gray-700 pb-2 text-gray-200">ğŸ¤ ë¼ì˜¤íƒ€ ë¦¬ë·°</h3>
                <ul id="review-list" class="space-y-4">${reviewListHtml}</ul>
            </div>
            ${loggedInUser ? addReviewForm : ''}
        </div>`;

    modal.classList.remove('hidden');
    modal.classList.add('flex');
    setTimeout(() => modalContent.classList.add('scale-100', 'opacity-100'), 10);

    document.getElementById('close-modal').addEventListener('click', closeModal);
    
    // AI ê¸°ëŠ¥ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    document.getElementById('ai-summary-btn').addEventListener('click', () => handleAiSummary(shop));
    document.getElementById('ai-pairing-btn').addEventListener('click', () => handleAiPairing(shop));

    if (loggedInUser) {
        document.getElementById('add-review-form').addEventListener('submit', handleAddReview);
        const starRatingContainer = document.getElementById('star-rating');
        const stars = starRatingContainer.querySelectorAll('.star');
        stars.forEach(star => {
            star.addEventListener('click', () => {
                const rating = star.dataset.value;
                starRatingContainer.dataset.rating = rating;
                stars.forEach(s => s.classList.toggle('selected', s.dataset.value <= rating));
            });
        });
    }
}

async function handleAiSummary(shop) {
    const resultDiv = document.getElementById('ai-summary-result');
    const button = document.getElementById('ai-summary-btn');
    button.disabled = true;
    button.innerHTML = '<div class="spinner"></div><span>ìš”ì•½ ì¤‘...</span>';
    resultDiv.classList.remove('hidden');
    resultDiv.innerText = 'AIê°€ ë¦¬ë·°ë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...';

    const allReviewsText = shop.reviews.map(r => `- ${r.comment}`).join('\n');
    const prompt = `ë‹¤ìŒì€ '${shop.name}' ë¼ë©˜ ê°€ê²Œì— ëŒ€í•œ ì „ë¬¸ê°€ë“¤ì˜ ë¦¬ë·°ì…ë‹ˆë‹¤. ì´ ë¦¬ë·°ë“¤ì„ í•œë‘ ë¬¸ì¥ì˜ í•µì‹¬ ë‚´ìš©ìœ¼ë¡œ ìš”ì•½í•´ì£¼ì„¸ìš”:\n\n${allReviewsText}`;
    
    const summary = await callGemini(prompt);
    resultDiv.innerText = summary;
    button.disabled = false;
    button.innerHTML = 'AI ë¦¬ë·° ìš”ì•½';
}

async function handleAiPairing(shop) {
    const resultDiv = document.getElementById('ai-pairing-result');
    const button = document.getElementById('ai-pairing-btn');
    button.disabled = true;
    button.innerHTML = '<div class="spinner"></div><span>ì¶”ì²œ ì¤‘...</span>';
    resultDiv.classList.remove('hidden');
    resultDiv.innerText = 'AIê°€ ì–´ìš¸ë¦¬ëŠ” ì¡°í•©ì„ ì°¾ê³  ìˆìŠµë‹ˆë‹¤...';

    const prompt = `'${shop.name}'ì˜ ëŒ€í‘œ ë©”ë‰´ì¸ ${shop.category} ë¼ë©˜ê³¼ ê°€ì¥ ì˜ ì–´ìš¸ë¦¬ëŠ” ì‚¬ì´ë“œ ë©”ë‰´ë‚˜ ìŒë£Œë¥¼ ì¶”ì²œí•´ì£¼ê³ , ê·¸ ì´ìœ ë¥¼ ê°„ë‹¨íˆ ì„¤ëª…í•´ì£¼ì„¸ìš”.`;
    
    const pairing = await callGemini(prompt);
    resultDiv.innerText = pairing;
    button.disabled = false;
    button.innerHTML = 'AI í˜ì–´ë§ ì¶”ì²œ';
}


function closeModal() {
    modalContent.classList.remove('scale-100', 'opacity-100');
    setTimeout(() => modal.classList.add('hidden'), 300);
}

function openLoginModal() { loginModal.classList.remove('hidden'); loginModal.classList.add('flex'); }
function closeLoginModal() { loginError.classList.add('hidden'); usernameInput.value = ''; loginModal.classList.add('hidden'); }

function handleLogin(e) {
    e.preventDefault();
    const username = usernameInput.value.trim();
    const user = raotaUsers.find(u => u.id === username);
    if (user) {
        loggedInUser = user;
        updateUIForLogin();
        closeLoginModal();
    } else {
        loginError.classList.remove('hidden');
    }
}

function handleLogout() { loggedInUser = null; loginBtn.classList.remove('hidden'); userInfo.classList.add('hidden'); }

function handleAddReview(e) {
    e.preventDefault();
    const shopId = Number(e.target.dataset.shopId);
    const selectedMenu = document.getElementById('review-menu-select').value;
    const rating = Number(document.getElementById('star-rating').dataset.rating);
    const reviewText = document.getElementById('review-text').value.trim();

    if (rating === 0) { alert('ë³„ì ì„ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }
    if (!reviewText) { alert('ë¦¬ë·° ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }

    const shop = allShopsWithDistance.find(s => s.id === shopId);
    if (shop) {
        const newReview = { user: loggedInUser.name, menu: selectedMenu, rating: rating, comment: reviewText };
        shop.reviews.push(newReview);

        const menuToUpdate = shop.menu.find(m => m.name === selectedMenu);
        const reviewsForMenu = shop.reviews.filter(r => r.menu === selectedMenu);
        menuToUpdate.rating = reviewsForMenu.reduce((sum, r) => sum + r.rating, 0) / reviewsForMenu.length;

        shop.avg_rating = shop.reviews.reduce((sum, r) => sum + r.rating, 0) / shop.reviews.length;

        openModal(shopId, shop.reviews.length - 1);
        applyFiltersAndSort();
    }
}

function updateUIForLogin() {
    userDisplay.textContent = `${loggedInUser.name}ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤!`;
    loginBtn.classList.add('hidden');
    userInfo.classList.remove('hidden');
    userInfo.classList.add('flex');
}

function initializeFilters() {
    const categories = ['all', ...new Set(ramenShops.map(s => s.category))];
    categoryFilters.innerHTML = categories.map(cat => `<button class="tag category-tag px-3 py-1 border rounded-full text-sm text-gray-300 ${cat === 'all' ? 'active' : ''}" data-category="${cat}">${cat === 'all' ? 'ì „ì²´' : cat}</button>`).join('');
    document.querySelectorAll('.category-tag').forEach(btn => btn.addEventListener('click', (e) => {
        document.querySelector('.category-tag.active').classList.remove('active');
        e.target.classList.add('active');
        currentFilters.category = e.target.dataset.category;
        applyFiltersAndSort();
    }));
    priceFilter.addEventListener('input', (e) => { currentFilters.maxPrice = Number(e.target.value); priceValue.textContent = currentFilters.maxPrice.toLocaleString(); });
    priceFilter.addEventListener('change', applyFiltersAndSort);
    distanceFilter.addEventListener('input', (e) => { currentFilters.maxDistance = Number(e.target.value); distanceValue.textContent = currentFilters.maxDistance; });
    distanceFilter.addEventListener('change', applyFiltersAndSort);
    resetFiltersBtn.addEventListener('click', () => {
        currentFilters = { category: 'all', maxPrice: 20000, maxDistance: 20 };
        currentSort = 'rating';
        priceFilter.value = 20000; priceValue.textContent = '20,000';
        distanceFilter.value = 20; distanceValue.textContent = '20';
        document.querySelector('.category-tag.active').classList.remove('active');
        document.querySelector('.category-tag[data-category="all"]').classList.add('active');
        document.querySelector('.sort-btn.active').classList.remove('active');
        document.querySelector('.sort-btn[data-sort="rating"]').classList.add('active');
        applyFiltersAndSort();
    });
}

// --- ì´ˆê¸°í™” ë° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---
document.addEventListener('DOMContentLoaded', () => {
    initializeFilters();
    
    loginBtn.addEventListener('click', openLoginModal);
    logoutBtn.addEventListener('click', handleLogout);
    loginForm.addEventListener('submit', handleLogin);
    closeLoginModalBtn.addEventListener('click', closeLoginModal);
    loginModalBg.addEventListener('click', closeLoginModal);

    modalBg.addEventListener('click', closeModal);
    window.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && !modal.classList.contains('hidden')) closeModal();
        if (e.key === 'Escape' && !loginModal.classList.contains('hidden')) closeLoginModal();
    });

    sortBtns.forEach(btn => btn.addEventListener('click', (e) => {
        const sortBy = e.currentTarget.dataset.sort;
        if (sortBy === 'distance' && !userLocation) {
            alert('ê±°ë¦¬ìˆœìœ¼ë¡œ ì •ë ¬í•˜ë ¤ë©´ ìœ„ì¹˜ ì •ë³´ê°€ í•„ìš”í•©ë‹ˆë‹¤. ë¨¼ì € ìœ„ì¹˜ ì •ë³´ë¥¼ í—ˆìš©í•´ì£¼ì„¸ìš”.');
            return;
        }
        currentSort = sortBy;
        sortBtns.forEach(b => b.classList.remove('active'));
        e.currentTarget.classList.add('active');
        applyFiltersAndSort();
    }));

    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            (position) => {
                userLocation = { lat: position.coords.latitude, lng: position.coords.longitude };
                locationStatus.textContent = `ğŸ“ í˜„ì¬ ìœ„ì¹˜ ê¸°ì¤€ (ë°ëª¨: ê°•ë‚¨ì—­)`;
                userLocation = { lat: 37.4979, lng: 127.0276 };
                allShopsWithDistance = ramenShops.map(shop => ({ ...shop, distance: getDistance(userLocation.lat, userLocation.lng, shop.geo.lat, shop.geo.lng) }));
                applyFiltersAndSort();
            },
            () => {
                userLocation = null;
                locationStatus.textContent = 'âš ï¸ ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ì–´ ì£¼ì†Œë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.';
                locationStatus.classList.add('text-red-400');
                allShopsWithDistance = ramenShops.map(shop => ({ ...shop, distance: null }));
                document.querySelector('.sort-btn[data-sort="distance"]').disabled = true;
                distanceFilter.disabled = true;
                applyFiltersAndSort();
            }
        );
    } else {
        userLocation = null;
        locationStatus.textContent = 'âš ï¸ ìœ„ì¹˜ ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.';
        allShopsWithDistance = ramenShops.map(shop => ({ ...shop, distance: null }));
        applyFiltersAndSort();
    }
});
</script>
</body>
</html>